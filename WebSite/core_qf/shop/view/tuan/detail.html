<link rel="stylesheet" type="text/css" href="tuan/style2.css" />
<script>
  /*商品详细通用函数*/
   var priceControl={
              base:<{$goods.price|cur:null:true}>,
              _format:<{$money_format|default:'false'}>,
              format:function(num){
                var part;
                if(!num)return;
                var num = num.toFloat();
                    num = num.round(this._format.decimals)+'';
                    var p =num.indexOf('.');
                    if(p<0){
                        p = num.length;
                        part = '';
                    }else{
                        part = num.substr(p+1);
                    }
                    while(part.length<this._format.decimals){
                            part+='0';
                        }
                    var c=[];
                    while(p>0){
                        if(p>2){
                            c.unshift(num.substr(p-=3,3));
                        }else{
                            c.unshift(num.substr(0,p));
                            break;
                        }
                    }
                    if(!part){
                        this._format.dec_point='';
                    }
                    return (this._format.sign||"")+c.join(this._format.thousands_sep)+this._format.dec_point+part;
            }
    };

    String.implement({
      toFormElements:function(){
            if(!this.contains('=')&&!this.contains('&'))return new Element('input',{type:'hidden'});
            var elements=[];
            var queryStringHash=this.split('&');
            $A(queryStringHash).each(function(item){
                if(item.contains('=')){
                    item=$A(item.split('='));
                    elements.push(new Element('input',{type:'hidden',name:item[0],value:item[1]}));
                }else{
                  elements.push(new Element('input',{type:'hidden',name:item}));
                }
            });
            return new Elements(elements);
            }
    });
    Number.implement({
           interzone:function(min,max){
                 var _v=this.toFloat();
                 if(!_v)_v=0;
                 return _v>=min&&_v<=max;
             }
          });
   var keyCodeFix=[48,49,50,51,52,53,54,55,56,57,96,97,98,99,100,101,102,103,104,105,8,9,46,37,39];
</script>

<div class="GoodsInfoWrap" id="tuangouwarp">
	<div id="goods-viewer">
    <!--团购开始-->
    <div class="home_deal_list"> 
    <form class="goods-action" action="<{link ctl=cart act=addGoodsToCart}>" gnotify="<{link ctl=product act=gnotify}>" method="post"<{if $goods.setting.buytarget==2}> target="_blank_cart"<{elseif $goods.setting.buytarget==3}> target="_dialog_minicart"<{/if}>>
        <input type="hidden" name="goods[goods_id]" value="<{$goods.goods_id}>" />
        <input type="hidden" name="goods[pmt_id]" value="<{$goods.pmt_id}>" />
        <input type="hidden" name="goods[specialprice]" value="<{$tuan.price}>"/>
        <input type="hidden" name="tuan[id]" value="<{$tuan.id}>" />
        <input type="hidden" name="tuan[conduser]" value="<{$tuan.conduser}>" />
        
        <!--当前团购开始-->
      <div id="deal_brief">
           <h1 class="goodsname">
              <span>今日团购: </span><{$tuan.name|escape:"html"}>
           </h1>
           <div class="clearfix">
           <!--左侧开始-->
          <div class="i-f1">
                <div class="choosel">
                <{if $goods.marketable != 'false'}>
                 <!---购物面板--->        
                 <div class="hightbox clearfix"<{if $goods.FlatSpec || $goods.SelSpec}><{else}> style="display:none"<{/if}>>     
                    <!---规格开始--->
                    <{if $goods.FlatSpec || $goods.SelSpec}>
                      <div id="goods-spec" class="goods-spec">
                        <input type='hidden' name='goods[product_id]' value='<{$goods.product_id}>' disabled='true' />
                         <{if $goods.FlatSpec}>
                            <!--平铺选择模式-->
                            <{foreach from=$goods.FlatSpec key=key item=goodsFlatSpecDesc}>
                               <dl class="spec-item specItem">
                                <dt><span>选择<em><{$goodsFlatSpecDesc.name}></em></span></dt>
                                <dd>
                                  <ul>
                                    <{foreach from=$goods.FlatSpec[$key].value key=skey item="subDesc"}>
                                    <{if $subDesc.display=="block"}><li><a href="<{link ctl=product act=index arg0=$goods.goods_id arg1=$subDesc.spec_goods_images}>" specvid="<{$skey}>" specid="<{$key}>" ><span><nobr><{$subDesc.spec_value}></nobr></span><i title='点击取消选择'>&nbsp;</i></a></li><{/if}>
                                    <{/foreach}>
                                  </ul>
                                </dd>
                               </dl>                                   
                            <{/foreach}>
                         <{/if}>
                         <{if $goods.SelSpec}>
                         <!--下拉模式-->
                          <div class="spec-item">
                                <ul class="clearfix">
                                <{foreach from=$goods.SelSpec key=selKey item=goodsSelSpecDesc}>
                                  <{foreach from=$goods.SelSpec[$selKey].value key=sSelKey item="subDesc"}>
                                    <{if $subDesc.selected}><{assign var='selectValue' value=$subDesc.spec_value}><{/if}>
                                  <{/foreach}>
                                    <li class="handle<{if $selectValue}> selected<{/if}>"><em><{$goodsSelSpecDesc.name}></em>：
                                    <span><{if $selectValue|trim == ''}><{assign var=selectValue value=null}><{/if}><{$selectValue|default:'请选择'}></span>
                                    <{assign var="selectValue" value=' '}>
                                   </li>
                                  <{/foreach}>
                                <{foreach from=$goods.SelSpec key=selKey item=goodsSelSpecDesc}>
                                   <li class="content specItem">
                                    <ul>
                                    <{foreach from=$goods.SelSpec[$selKey].value key=sSelKey item="subDesc"}>
                                        <{if $subDesc.display=="block"}>
                                        <li>
                                        <a href="<{link ctl=product act=index arg0=$goods.goods_id arg1=$subDesc.spec_goods_images}>" specvid="<{$sSelKey}>" specid="<{$selKey}>"><span><{$subDesc.spec_value}></span><i title='点击取消选择'>&nbsp;</i>
                                        </a>
                                        </li>                
                                        <{/if}>
                                    <{/foreach}>
                                  </ul>
                                  </li>                    
                                  <{/foreach}>
                               </ul>
                          </div>
                         <{/if}>
                      </div>
                      
                 <{/if}>
                <!---规格结束--->
             </div>
             <!--end hightbox-->                  
              <div class="buyinfo clearfix">
                 <table>
                    <tr>
                        <td>&nbsp;&nbsp;我要买&nbsp;</td>
                        <td>
                        <div class="Numinput">
                        <input type="text" name="goods[num]" size="5" value="1" />  
                        <span class="numadjust increase"></span>                          
                        <span class="numadjust decrease"></span>
                        </div>
                        </td>
                        <td style="padding-left:15px;"><span<{if !$showStorage}> style="display:none"<{/if}>>库存&nbsp;<span class="store"><{if $goods.store >= 9999 || $goods.store == null || $goods.store === ''}>9999+<{else}><{$goods.store - $goods.product_freez}><{/if}></span>
                        </td>
                    </tr>
                 </table>
              </div>                
             <{if $goods.FlatSpec || $goods.SelSpec}><div class="spec-tip"><em><{if $SelectSpecValue.selected}>您选择了：<{else}>请先选择：<{/if}></em><span><{$SelectSpecValue.value}></span></div><{/if}>
         <{/if}>
         </div> <!--choose end-->
          
         <div class="choomain">
            <div class="deal-buy">
                <div class="deal-price-tag"></div>
                <div class="deal-price">
                	<strong><{$tuan.price|number_format:'1'}></strong>
                    <!--btnBar begin--> 
                    <span class="btnBar<{if $tuan.salestate=='soldout'}> sold_out<{/if}>">
                     <{if count($goods.products)>0}>
                        <{if $env.conf.system.goods.fastbuy}>
                            <input class="actbtn btn-fastbuy hidden" value="立即购买" type="button" />
                        <{/if}>
                        <{if $goods.iscountdown==""}>
                        <input class="actbtn btn-buy" value="加入购物车" type="submit" />
                        <{else}>
                        <input class="actbtn btn-buy" style="background:url('statics/btn-buy-disabled.gif') repeat scroll 0 0 transparent;float:left;width:120px" value="加入购物车禁用1" type="button" title="限时抢购商品不能加入购物车" onclick="javascript:alert('限时抢购商品不能加入购物车');void(0);"/>
                        <{/if}>
                        <input class="actbtn btn-notify hidden" value="缺货登记" type="submit" style="display: none;" />
                    <{else}>
                    <{if $goods.store-$goods.freez>0 || $goods.store==''}>
                        <{if $env.conf.system.goods.fastbuy}>
                            <input class="actbtn btn-fastbuy hidden" value="立即购买" type="button" />
                        <{/if}>
                        <{if $goods.iscountdown==""}>
                            <input class="actbtn btn-buy" value="加入购物车" type="submit" />
                        <{else}>
                            <input class="actbtn btn-buy" style="background:url('statics/btn-buy-disabled.gif') repeat scroll 0 0 transparent;float:left;width:120px" value="加入购物车禁用2" type="button" title="限时抢购商品不能加入购物车" onclick="javascript:alert('限时抢购商品不能加入购物车');void(0);"/>
                        <{/if}>
                    <{else}>
                        <input  class="actbtn btn-notify hidden" value="缺货登记" type="submit" />
                    <{/if}>
                    <{/if}>
                  </span>
                  <!--btnBar end-->
               </div>
          </div>
           <table class="deal-discount">
                    <tbody>
                    <tr><th>原价</th> <th>折扣</th> <th>节省</th></tr>
                    <tr>
                        <td id="team-market_price-10757331">
                        <{if $goods.minmktprice && $goods.maxmktprice}>
                        <{if $goods.minmktprice neq $goods.maxmktprice}>
                            <{$goods.minmktprice|cur}><br/>-<{$goods.maxmktprice|cur}>
                        <{else}>
                            ¥<{$goods.minmktprice|number_format:'1'}>
                        <{/if}>
                   <{else}>
                    ¥<{$goods.mktprice|number_format:'1'}>
                   <{/if}></td>
                        <td id="team-discount-10757331"><{$goods.price/$goods.mktprice*10|number_format:'1'}></td>
                        <td id="team-save-10757331">¥<{$goods.mktprice-$goods.price|number_format:'1'}></td>
                    </tr>
                	</tbody>
              </table>
                                      
            <!--倒计时开始-->     
            <{if $goods.marketable=='false' || ( $tuan.salestate=='soldout')}>
                <div class="deal-box deal-timeleft deal_end">
                	<span>本特卖已结束</span>
                    <span style="display:none"><{$tuan.expire_time|cdate:'FDATE_FTIME'}></span>
                 </div>
                <{else}>
                <div class="deal-box deal-timeleft deal_on">
                	<span class="sktimeleft">剩余时间</span>
                	<span id="timer"><em>时</em> <em>分</em> <em class="dot">&nbsp;</em> <em>秒</em></span>
                </div>
            <{/if}>            
            <!--倒计时结束-->
                         
             <div class="deal-box deal-timeleft deal-status">
             
              <{if $goods.marketable=='false' || ( $tuan.salestate=='soldout')}>
                                   <span class="purhcase_number">共<strong><{$tuan.tuannow}></strong>人购买</span>

              <{else}>
             
                <{if $tuan.salestate != 'soldout'}>  
                    <span class="purhcase_number"><strong><{$tuan.tuannow}></strong>人已经购买<{if !$showStorage}> 还剩<strong><{$tuan.max_number-$tuan.tuannow}></strong>件<{/if}></span>
                    <{if $tuan.tuannow >= $tuan.min_number}><span class="secc">团购成功！ 可继续购买 </span><{else}><span class="secc">还差<{$tuan.min_number -$tuan.tuannow}>人成团，赶紧加入吧！</span><{/if}>
                <{else}>
                     <span class="purhcase_number">共<strong><{$tuan.tuannow}></strong>人购买</span>
                     <span class="soldout">抢光了</span>
                 <{/if}>  
                 
                 <{/if}>
               </div>
           	<div class="clear"></div>
          </div>
       </div><!--tgshow end-->
            
        <!--bigpic-->
          <div class="autoinner">
               <div class="goodspic" style="<{if $env.conf.site.small_pic_width !=0}>width:<{$env.conf.site.small_pic_width+50}>px;margin:0 auto;<{/if}>padding:0;"><{require file="tuan/goodspics.html"}></div>
          </div>
        <!--bigpic end-->
        <div class="clear"></div>
        </div>
        <{if $goods.brief}><div id="deal_note"><{$goods.brief}></div><{/if}>
      </div>
    </form>
    
    <div class="clear"></div>  
    
    <!--立即购买FROM-->
    <{if $env.conf.system.goods.fastbuy}>
    <form id='fastbuy-form' action='<{link ctl="cart" act="checkout"}>' extra='fastbuy' method='post' style='display:none;'></form>
    <{/if}>
    <!--立即购买FROM END-->    
    
   <!--货品列表-->
    <{if count($goods.products)>0}>
    <div id='goods-products-list' class='goods-products-list'>
        <div class='goods-products-list-box'>
            <table width="100%" cellpadding="3" cellspacing="0" class="liststyle">
                <{foreach from=$specShowItems item=spec}>
                    <col class='ColColorBlue'></col>
                <{/foreach}>
                <col></col>
                <col></col>
                <col></col>
                <thead>
                    <tr>
                        <{foreach from=$specShowItems item=spec key=key}>
                            <th><{$spec}></th>
                        <{/foreach}>
                        <th>货号</th>
                        <th>价格</th>
                        <{if $env.conf.site.show_storage=="true"}><th>库存</th><{/if}>
                    </tr>
                </thead>
                <tbody>
                <{foreach from=$goods.products item=item}>
              <tr productid="<{$item.product_id}>" <{if $item.store!==null && $item.store !=='' && ($item.store - $item.freez <= 0)}>class='nostore' title='此货品缺货'<{/if}>>
                    <{foreach from=$item.props.spec key=key item=value}>
                    <td><{$value}></td>
                    <{/foreach}>
                    <td class="ident"><{$item.bn}></td>
                    <td class="price"><{$item.price|cur}></td>
                    <{if $env.conf.site.show_storage=="true"}><td class="store"><{if $item.store!==null && $item.store !=='' && ($item.store - $item.freez <= 0)}>缺货<{else}><{$item.store}><{/if}></td><{/if}>
                </tr>
                <{/foreach}>
                </tbody>
            </table>
          </div>
     </div>
    <{/if}>
</div>

<div class="clear"></div>

<!------------------------------------ 购买区域 结束 -------------------------------->


<div class="goods-detail-tab clearfix"></div>
<{foreach from=$addons item=tmpl}><{require file=$tmpl}><{/foreach}>

<{if $goods.intro}>
<div class="section pdtdetail" tab="商品详情">
    <div class="body">
        <div class="goodsprop_ultra clearfix">
            <{if $goodspropposition<>1}>
            <{foreach from=$goods.prototype.ordernum item=propord key=key}>
              <{if $goods.prototype.props.$propord.show}>
              <{assign var="pkey" value="p_{$propord}"}>
              <{assign var="pcol" value=$goods.$pkey}>
              <{if trim($pcol) !== ''}>
              <div class="span-4">
              <span><{$goods.prototype.props.$propord.name}>：</span>
              <{if $goods.prototype.props.$propord.type == 'select'}>
                <{if $goodsproplink}><a href="<{selector type=$goods.type_id key=$propord value=$pcol}>" target="_blank"><{$goods.prototype.props.$propord.options.$pcol}></a><{else}><{$goods.prototype.props.$propord.options.$pcol}><{/if}>
              <{else}>
                <{$pcol}>
              <{/if}>
              </div>
              <{/if}>
              <{/if}>
            <{/foreach}>
        <{/if}>
    </div>
    <div class="indent uarea-output" id="goods-intro"><{$goods.intro}></div>
 </div>
</div>
<{/if}>


<{if count($goods.params)>0 && $goods.params}>
<div class="section pdtdetail" tab="详细参数" rel="noshow">
<div class="ptitle">
	<h2><span><{t}>详细参数<{/t}></span></h2>
</div>
<div class="body"  id="goods-params">
<table width="100%" cellpadding="0" cellspacing="0" class="liststyle data">
<col class="span-4 ColColorGray fontcolorBlack"></col>
  <{foreach from=$goods.params item=params key=group}>
  <tr><td colspan="2" class="colspan ColColorGraydark"><{$group}><span class="gname"></span></td></tr>
    <{foreach from=$params item=value key=key}>
        <{if $value != ''}>
      <tr><th><{$key}></th><td><{$value|default:'-'}></td></tr>
        <{/if}>
        <{/foreach}>
  <{/foreach}>
  </table>
</div>
</div>
<{/if}>


<{if $goods.link_count > 0}>
<div class="section pdtdetail" tab="相关商品">
<div class="ptitle">
	<h2><span><{t}>相关商品<{/t}></span></h2>
</div>
<div class="body" id="goods-rels">
  <div class="GoodsSearchWrap">
    <table width="100%" border="0" cellpadding="0" cellspacing="6">
  <tr valign="top"> <{foreach from=$goods.link item=linklist name=goods}>
    <td product="<{$linklist.goods_id}>" width="25%">
    <div class="items-gallery">
    <div class="goodpic" style='<{if $env.conf.site.thumbnail_pic_width !=0 && $env.conf.site.thumbnail_pic_height !=0}>height:<{$env.conf.site.thumbnail_pic_height}>px;<{/if}>'>
    <a href='<{link ctl="product" act="index" arg0=$linklist.goods_id}>' style='<{if $env.conf.site.thumbnail_pic_width !=0 && $env.conf.site.thumbnail_pic_width !=0}> width:<{$env.conf.site.thumbnail_pic_width}>px;height:<{$env.conf.site.thumbnail_pic_height}>px;<{/if}>;'><img src="<{$linklist.thumbnail_pic|default:$env.conf.site.default_thumbnail_pic|storager}>" /></a></div>
     <div class="goodinfo">        
			<h6><a href="<{link ctl="product" act="index" arg0=$linklist.goods_id}>" title="<{$linklist.name}>"><{$linklist.name}></a></h6>
			<ul>
				<li><{if $goods.setting.mktprice}><span class="mktprice1"><{$linklist.mktprice|cur}></span><{/if}>&nbsp;&nbsp;<span class="price1"><{$linklist.price|cur}></span></li>
			</ul>
      </div>
      </div>
      </td>
    <{if !($smarty.foreach.goods.iteration%4)}> </tr>
  <{if !$smarty.foreach.goods.last}>
  <tr valign="top"> <{/if}>

    <{elseif $smarty.foreach.goods.last}>
    <td colspan="<{math equation='4 - y' y=$smarty.foreach.goods.iteration%4}>">&nbsp;</td>
  </tr>
  <{/if}>
  <{/foreach}>
</table>
  </div>
</div>
</div>
<{/if}>

<{if $sellLog.display.switch  && $sellLogList.data|@count >0 && $sellLog.display.limit<= $sellLogList.data|@count }>
<div class="section pdtdetail" tab="销售记录" rel="noshow">
<div class="ptitle">
		<h2><span><{t}>销售记录<{/t}></span></h2>
		<span class="tabr"><{t}>截至今日， 累计成交<{/t}><em><{$sellLogList.total}><{t}></em>笔<{/t}><{if $sellLogList.total > $sellLogList.data|@count}>，<a href="<{link ctl=product act=selllog arg0=$goods.goods_id}>" target="_blank"><{t}>查看更多...<{/t}></a><{/if}>	</span>
</div>
<div class="body">
    <table border="0" cellpadding="0" cellspacing="0" width="100%" class="liststyle">
    <col class="span-5">
    <col class="span-3">
    <col >
    <col class="span-3">
    <thead>
        <tr>
            <th><{t}>买家<{/t}></th>
            <th><{t}>购买价<{/t}></th>
            <th><{t}>购买数量<{/t}></th>
            <th><{t}>购买时间<{/t}></th>
        </tr>
        </thead>
        <tbody>
        <{foreach from=$sellLogList.data item=sellLogListData key=key}>
        <tr>
            <td><{$sellLogListData.name|cut:3:''}>***</td>
            <td><{$sellLogListData.price}></td>
            <td><{$sellLogListData.number}>  <{if $sellLogListData.pdt_desc}><span class="fontcolorGray">( <{$sellLogListData.pdt_desc}> )</span><{/if}></td>
            <td><{$sellLogListData.createtime|userdate}></td>
        </tr>
        <{/foreach}>


        </tbody>
    </table>
<div class="tips"><{t}>截至今日， 累计成交<{/t}><span class="font14px fontbold fontcolorOrange"><{$sellLogList.total}></span><{t}>笔<{/t}><{if $sellLogList.total > $sellLogList.data|@count}><a href="<{link ctl=product act=selllog arg0=$goods.goods_id}>" target="_blank"><{t}>，查看更多...<{/t}></a><{/if}></div>
</div>
</div>
<{/if}>

<!--by qingfeng 20121129--优化评论咨询板块-->
<{if $comment.switch.ask == 'on'}><!--是否开启咨询功能-->
        <!--无论是否有权限，通用显示，调用咨询内容-->
        <div class="section pdtdetail ask-list" tab="购买咨询 (<em><{$comment.askCount|default:'0'}></em>)">
        	<div class="commentTabLeft">
                 <strong><{t}>购买咨询<{/t}></strong>
                 <span><a href="<{link ctl="comment" act="commentlist" arg0=$goods.goods_id arg1="ask"}>"><{t}>（已有<{/t}><em><{$comment.askCount|default:'0'}></em><{t}>条咨询）<{/t}></a></span>
            </div>
          
          <!--FormWrap开始-->
          <div class="FormWrap">
            <!--没有咨询-->
            <{if count($comment.list.ask) == 0}>
                <div class="boxBrown"><{$comment.null_notice.ask}></div>
            <{else}>
            <!--有评论-->
            <div class="Comments" id="goods-comment">
                <{foreach from=$comment.list.ask item=comlist name=asklist}>
                    <div class="commentMain">
                        <div class="ask-user">
                            <span class="author"><strong><{$comlist.author}></strong>&nbsp;发布咨询：</span>
                            <span class="timpstamp">时间：<{$comlist.time|cdate:'SDATE_STIME'}></span>
                        </div>
                        <div class="ask-section clearfix">
							<div class="floatRight"><a class="lnk" href='<{link ctl="comment" act="reply" arg0=$comlist.comment_id arg1="ask"}>'><{t}>回复此咨询<{/t}></a></div>
                            <span><{$comlist.comment|escape:'html'}></span>
                        </div>
                    </div>
                    
                    <div class="commentReply">
                          <{foreach from=$comlist.items item=items name=askquote}>
                                <div class="ask-reply clearfix <{if $smarty.foreach.askquote.first}>first<{/if}>">
                                    <div class="ask-arrow"></div>
									 <div class="floatRight"><span class="author"><{$items.author}><{t}><{/t}></span>&nbsp;回复于&nbsp;<span class="timpstamp"><{$items.time|cdate:'SDATE_STIME'}></span></div>
                                    <{$items.comment}>
                                </div>
                            <{/foreach}>
                      </div>
                  <{/foreach}>
              </div>
              <div class="textright ask-num"><a href="<{link ctl="comment" act="commentlist" arg0=$goods.goods_id arg1="ask"}>"><{t}>查看更多问答(<span><{$comment.askCount|default:'0'}></span>)<{/t}></a></div>
            <{/if}>
            
            <!--评论输入面板开始-->
            <{if $comment.power.ask !='null' && $comment.member_lv < 0}><!--如果没有评论权限，提示登陆-->
             <!--提示未登陆用户登陆-->
             <div class="boxBrown division"><a href="<{link ctl=passport act=login}>"><image src="statics/btn-ask.gif" alt="登陆" /></a></div>
             <!--提示未登陆用户结束--->
            <{else}>
            <!--有评论权限，显示评论面板-->   
            <form class="addcomment" method="post" action='<{link ctl="comment" act="toComment" arg0=$goods.goods_id arg1="ask"}>' onsubmit='checkFormReqs(event);'>
              <h4><{t}>发表咨询<{/t}></h4>
              <div class="division">
                <table border="0" cellpadding="0" cellspacing="0" width="100%" class="forform">
                   <tr class="title">
                  	<th><{t}>标题：<{/t}></th>
                    <td><{input type="text" class="inputstyle blur" required="true" size=50 name="title" value="[咨询]".$goods.name}></td>
                  </tr>
                  <tr>
                    <th><em>*</em><{t}>您的问题：<{/t}></th>
                    <td><{input type="textarea" class="x-input inputstyle"  vtype="required" rows="5" name="comment" style="width:80%;"}></td>
                  </tr>
                  <tr>
                    <th><{t}>联系方式：<{/t}></th>
                    <td><{input type="text" class="inputstyle" size=20 name="contact"}><span class="infotips"><{t}>(可以是电话、email、qq等).<{/t}></span></td>
                  </tr>
                  <{if $askshow == "on"}>
                  <tr>
                    <th><em>*</em><{t}>验证码：<{/t}></th>
                    <td><{input type="text" required="true" size="4" maxlength="4" name="askverifyCode"}>&nbsp;<img src="<{link ctl="passport" act="verifyCode" arg0="ask"}>" border="1" id="askimgVerifyCode"/><a href="javascript:changeimg('askimgVerifyCode','ask')"><{t}>&nbsp;看不清楚?换个图片<{/t}></a></td>
                  </tr>
                  <{/if}>
                  <tr>
                    <td></td>
                    <td><input type="submit" class="ask-submit" value="提交咨询"></td>
                  </tr>
                </table>
              </div>
            </form>
            <!--评论输入面板结束-->
            <{/if}>
                
           </div>
           <!--FormWrap 结束-->
        </div>
        <{/if}>
    
    
    <{if $comment.switch.discuss == 'on'}><!--是否开启评论功能-->
        <!--无论是否有权限，通用显示，调用评论内容-->
        <div class="section pdtdetail com-list" tab="商品评论 (<em><{$comment.discussCount|default:'0'}></em>)">
           <div class="commentTabLeft">
                 <strong><{t}>商品评论<{/t}></strong>
                 <span><a href="<{link ctl="comment" act="commentlist" arg0=$goods.goods_id arg1="discuss"}>"><{t}>（已有<{/t}><em> <{$comment.discussCount|default:'0'}> </em><{t}>条评论）<{/t}></a></span>
           </div>
                      
          <!--FormWrap开始-->
          <div class="FormWrap">
             <!--没有评论-->
            <{if count($comment.list.discuss) == 0}>
                <div class="boxBrown"><{$comment.null_notice.discuss}></div>
            <{else}>
            <!--有评论-->
               <div class="Comments" id="goods-comment">
                <{foreach from=$comment.list.discuss item=comlist name=discusslist}>
                    <div class="commentMain">
                        <div class="ask-user">
                            <span class="author">用户：<strong><{$comlist.author}></strong></span>
                            <span class="timpstamp">时间：<{$comlist.time|cdate:'SDATE_STIME'}></span>
                        </div>
                        <div class="ask-section clearfix">
							<div class="floatRight"><a class="lnk" href='<{link ctl="comment" act="reply" arg0=$comlist.comment_id arg1="ask"}>'><{t}>回复此评论<{/t}></a></div>
                        	<{$comlist.comment|escape:'html'}>
                        </div>
                    </div>
                    
                    <div class="commentReply">
                          <{foreach from=$comlist.items item=items name=quote}>
                                <div class="ask-reply clearfix">
                                    <{if $smarty.foreach.quote.first}><div class="ask-arrow"></div><{/if}>
									<div class="floatRight"><span class="author"><{$items.author}></span>&nbsp;回复于&nbsp;<span class="timpstamp"><{$items.time|cdate:'SDATE_STIME'}></span></div>
                                    <{$items.comment}>                                    
                                </div>
                            <{/foreach}>
                      </div>
                  <{/foreach}>
              </div>
              <!--div class="textright"><a href="<{link ctl="comment" act="commentlist" arg0=$goods.goods_id arg1="discuss"}>"><{t}>查看所有评论&gt;&gt;<{/t}></a></div-->
              <div class="textright ask-num"><a href="<{link ctl="comment" act="commentlist" arg0=$goods.goods_id arg1="discuss"}>"><{t}>查看更多评论(<span><{$comment.discussCount|default:'0'}></span>)<{/t}></a></div>
            <{/if}>
            
            <!--评论输入面板开始-->
            <{if $comment.power.discuss !='null' && $comment.member_lv < 0}><!--如果没有评论权限，提示登陆-->
             <!--提示未登陆用户登陆-->
             <div class="boxBrown division"><a href="<{link ctl=passport act=login}>"><image src="statics/btn-discuss.gif" alt="登陆" /></a></div>
             <!--提示未登陆用户结束--->
            <{else}>
            <!--有评论权限，显示评论面板-->   
            <form class="addcomment" method="post" action='<{link ctl="comment" act="toComment" arg0=$goods.goods_id arg1="discuss"}>' onsubmit='checkFormReqs(event);'>
              <h4><{t}>发表评论<{/t}></h4>
              <div class="division">
                <table border="0" cellpadding="0" cellspacing="0" width="100%" class="forform">
                  <tr class="title">
                  	<th><{t}>标题：<{/t}></th>
                    <td><{input type="text" class="inputstyle blur"  required="true" size=50 name="title" value="[评论]".$goods.name}></td>
                  </tr>
                  <tr>
                    <th><em>*</em><{t}>评论内容：<{/t}></th>
                    <td><{input type="textarea" class="x-input inputstyle" vtype="required" rows="5" name="comment" style="width:80%;"}></td>
                  </tr>
                  <tr>
                    <th><{t}>联系方式：<{/t}></th>
                    <td><{input type="text" class="inputstyle" size=20 name="contact"}><span class="infotips"><{t}>(可以是电话、email、qq等).<{/t}></span></td>
                  </tr>
                  <{if $discussshow == "on"}>
                  <tr>
                    <th><em>*</em><{t}>验证码：<{/t}></th>
                    <td><{input type="text" required="true" size="4" maxlength="4" name="discussverifyCode"}>&nbsp;<img src="<{link ctl="passport" act="verifyCode" arg0="discuss"}>" border="1" id="discussimgVerifyCode"/><a href="javascript:changeimg('discussimgVerifyCode','discuss')"><{t}>&nbsp;看不清楚?换个图片<{/t}></a></td>
                  </tr>
                  <{/if}>
                  <tr>
                    <td></td>
                    <td><input type="submit" class="discuss-submit" value="提交评论" /</td>
                  </tr>
                </table>
              </div>
            </form>
            <!--评论输入面板结束-->
            <{/if}>
                
           </div>
           <!--FormWrap 结束-->
        </div>
 <{/if}>
 <!--by qingfeng 20121129--优化评论板块-->

<{if count($gift)>0}>
<div class="section pdtdetail" tab="赠品" rel="noshow">
<div class="ptitle">
	<h2><span><{t}>赠品<{/t}></span></h2>
	<span class="tabr"></span>
</div>
<div class="body" id="goods-gift">
  <div class="GoodsSearchWrap">
    <{foreach from=$gift item=gift key=key}>
      <div class="items-list" product="<{$gift.gift_id}>">
      <div class="goodpic">
      <{input type="checkbox" name="g[]" value=$gift.goods_id }>
      <a href="<{link ctl="product" act="index" arg0=$gift.goods_id}>" title="<{$gift.name}>" style='<{if $env.conf.site.thumbnail_pic_width !=0 && $env.conf.site.thumbnail_pic_width !=0}> width:<{$env.conf.site.thumbnail_pic_height}>px;height:<{$env.conf.site.thumbnail_pic_height}>px;<{/if}>
     overflow:hidden;text-align:center;vertical-align: middle;margin:0px auto; line-height:<{$env.conf.site.small_pic_height}>px;'>
        <img src="<{$goods.image_default|gimage:'thumbnail'}>" alt="<{$gift.name}>"/></a></div>
      <div class="goodinfo">
        <h6><a href="<{link ctl="gift" act="index" arg0=$gift.gift_id}>" title="<{$gift.name}>"><{$gift.name}></a></h6>
        <ul>
        <li class="intro"><{$gift.intro}></li>
        <li><{$gift.describe}></li>
        </ul>
      </div>
      <div class="clear"></div>
      </div>
      <{/foreach}>
  </div>
</div>
</div>
<{/if}>

<{if count($coupon)>0}>
<div class="section pdtdetail" tab="优惠券" rel="noshow">
<div class="ptitle">
	<h2><span><{t}>优惠券<{/t}></span></h2>
	<span class="tabr"></span>
</div>
<div class="body" id="goods-coupon">
  <ul style="padding:5px 20px;">
  <{foreach from=$coupon item=coupon key=key}>
    <li><{$coupon.cpns_name}></li>
  <{/foreach}>
  </ul>
</div>
</div>
<{/if}>

</div>
</div>

<script>
    
    $$('.addcomment .title input').addEvents({
         'focus':function(){this.removeClass('blur');},
         'blur':function(){this.addClass('blur');}
    });

</script>





<{if $goods.marketable != 'false' }>

<script>




 var buycoutText=$E('#goods-viewer .buyinfo input[type=text]').addEvent('keydown',function(e){
             if($A(keyCodeFix).include(e.code).length>25){
               e.stop();
              }
         });
    var getStore=function(){
    return $E('#goods-viewer .store').get('text').toInt()
    };
         buycoutText.addEvent('keyup',function(e){

            if(getStore()<this.value)this.value=getStore();
            if(!this.value||this.value.toInt()<1)this.value=1;
         });
        /*购买数量调节*/
         $$('#goods-viewer .buyinfo .numadjust').addEvent('click',function(e){
              var countText=$E('#goods-viewer .buyinfo input[name^=goods[num]');
              if(this.hasClass('increase')){
                 countText.set('value',(countText.value.toInt()+1).limit(1,getStore()));
              }else{
                 countText.set('value',(countText.value.toInt()-1).limit(1,getStore()));
              }
              this.blur();
         });

         $$('#goods-viewer .buyinfo .numadjust').addEvents({
             'mousedown':function(){
                this.addClass('active');
             },
             'mouseup':function(){
               this.removeClass('active');
             }
         });

</script>


<{if ($goods.FlatSpec || $goods.SelSpec) && count($goods.products)>0  }>
<script>
      /*=规格选择联动=
      *(c) shopex.cn
      * 2009-2
      */

 void function(){
          var buyBtn=$empty;
          var notifyBtn=$empty;
          var setbuyBtnTip=$empty;
          var popAloneSpec=$empty;

         window.addEvent('domready',function(){

              buyBtn=$E('#goods-viewer .btn-buy').store('tip:text','');
              notifyBtn=$E('#goods-viewer .btn-notify').store('tip:text','对不起,您当前选择的商品缺货.');

             new Tips(buyBtn,{showDelay:0,hideDelay:0,className:'cantbuy',
                     onShow:function(tip){
                        if(!this.textElement||!$E('.tip-text',tip)||!$E('.tip-text',tip).getText()){
                            buyBtn.setStyle('cursor','pointer');
                            return tip.setStyle('visibility','hidden');
                        }else{
                            buyBtn.setStyle('cursor','not-allowed');
                        }
                        tip.setStyles({
							'visibility':'visible',
							'z-index':999
						});
                     }
              });
              new Tips(notifyBtn,{className:'cantbuy',showDelay:0,hideDelay:0});

               buyBtn.addEvent('click',function(e){
                   e.stop();
                   this.blur();
                   if(this.retrieve('tip:text'))return false;

                   this.form.submit();

               });
               notifyBtn.addEvent('click',function(e){
                      e.stop();
                      this.blur();
                      new Element('form',{method:'post','action':$(this.form).get('gnotify')}).adopt(
                         this.form.toQueryString().toFormElements()
                      ).inject(document.body).submit();
                });
              notifyBtn.addEvents({
                  'onhide':function(){
                       if($(this).getPrevious('.btn-fastbuy'))
                      $(this).getPrevious('.btn-fastbuy').setStyle('visibility','visible');
                  }
              });

                /*快速购买*/
              var fastbuyBtn = $E('#goods-viewer .btn-fastbuy');
              if(fastbuyBtn){
                      fastbuyBtn.store('tip:text','').addEvent('click',function(e){
                           e.stop();
                           this.blur();
                           if(this.retrieve('tip:text'))return false;
                           var form = $('fastbuy-form');
                           form.empty().adopt($(this.form).toQueryString().toFormElements());
                           form.adopt(new Element('input', {name:'isfastbuy',value:1,type:'hidden'}));
                           /*check min/maxorder by showker2011-1-22begin*/
                          if('<{$goods.minorder|trim}>'){
                           var sknum=$E('#goods-viewer .buyinfo input[name^=goods[num]').value;
                           var skminorder='<{$goods.minorder|trim}>';
                          if(sknum>parseInt(skminorder)){                  
                            alert("该商品限制购买数量为"+skminorder+",您的购买数量超出了");return false;
                           }
                           }
                           /*check min/maxorder by showker2011-1-22begin*/
                           if(!form.retrieve('events',{})['submit'])return form.submit();
                           form.fireEvent('submit',e);

                       });

                      new Tips(fastbuyBtn,{showDelay:0,hideDelay:0,className:'cantbuy',
                                 onShow:function(tip){
                                    if(!this.textElement||!$E('.tip-text',tip)||!$E('.tip-text',tip).getText()){
                                        fastbuyBtn.setStyle('cursor','pointer');
                                        return tip.setStyle('visibility','hidden');
                                    }else{
                                        fastbuyBtn.setStyle('cursor','not-allowed');
                                    }
                                    tip.setStyles({
										'visibility':'visible',
										'z-index':999
									});
                                 }
                          });
               }

               setbuyBtnTip=function(){
                    var spec_item_nocheck=[];
                     $('goods-spec').getElements('.spec-item em').each(function(em){
                        if(!em.hasClass('check'))spec_item_nocheck.include(em.getText());
                    });
                    
                     if(spec_item_nocheck.length>0){
                        $$(buyBtn,fastbuyBtn).store('tip:text','请选择'+spec_item_nocheck.join(','));
                     }else{
                        $$(buyBtn,fastbuyBtn).store('tip:text','');
                     }
                     return arguments.callee;
                 }();

             popAloneSpec=function(){
                var specs = $$('#goods-spec .spec-item','#goods-spec .spec-item .content');
                    specs.each(function(si){
                          var specs=si.getElements('a[specid]');
                          if(!specs.length){return $('#goods-viewer').getElement('.hightbox').empty().set('html','<b>该商品的所有规格货品已下架</b>').addClass('note')}
                          if(specs.length>1)return false;
                          if(specs[0].hasClass('selected')||specs[0].hasClass('lock'))return false;
                          specs[0].fireEvent('click');
                });


               return arguments.callee;

             }();
                 if(btnBar = $E('#goods-viewer .btnBar')){
                    btnBar.setStyle('visibility','visible');
                 }
         });


          var getSpecText=function(el){
             if($E('img',el))
             return $E('img',el).alt||$E('img',el).title;
             return $E('span',el).get('text');
          };

          var specItems=$ES('#goods-spec .spec-item em');
          var referencePoint={
          bn:$('goodsBn'),
          weight:$('goodsWeight'),
                  marketPrice:$E('#goods-viewer .mktprice1'),
                  price:$E('#goods-viewer .price1'),
                  discount:$E('#goods-viewer .discount'),
                  store:$E('#goods-viewer .store'),
                  specTip:$E('#goods-viewer .spec-tip'),
                  update:function(v,html){
                     return referencePoint[v]?referencePoint[v].setHTML(html):false;
                  }
          };
          var RPSV=$H(referencePoint).getValues();
          RPSV.each(function(el){
               if(el&&$type(el)=='element')
               el.retrieve('defaultInnerHTML',el.get('html'));
          });

          var referencePointDef=function(){
                RPSV.each(function(el){
                   if(el&&$type(el)=='element')
                   el.setHTML(el.retrieve('defaultInnerHTML'));
               });
               if($E('#goods-viewer .mprice'))$E('#goods-viewer .mprice').hide();
               updatepic();
               buyBtn.show();
               notifyBtn.hide();

          };




          var PRODUCT_HASH=new Hash(<{$goods.product2spec}>);
          var PRODUCT_SPECV_ARR=[];
              PRODUCT_HASH.each(function(v){
                   PRODUCT_SPECV_ARR.push(v['spec_private_value_id']);
              });
        
          var SPEC_HASH=new Hash(<{$goods.spec2product}>);
          
         

          /* var updatepicRequest=new Request.HTML({url:'<{link ctl=product act=goodspics}>',
                                                 update:$E('#goods-viewer .goodspic'),
                                                 autoCancel:true,
                                                 onRequest:function(){
                                                  }
                                                });
         相册联动*/
          var updatepic=function(vids){
              
              if(!vids)return $$('.goods-detail-pic-thumbnail td[img_id]').each(Element.show);
              vids = vids.split(',');
   
              var pointer = false;
              $$('.goods-detail-pic-thumbnail td[img_id]').each(function(i){
                        
                        if(vids.contains(i.get('img_id'))){
                            i.style.display = '';
                            if(!pointer){
                               i.getElement('a').fireEvent('click',{stop:$empty});
                               pointer = true;
                            }
                        }else{
                            
                            i.style.display = 'none';
                            
                        }
              });
          };


          /*其他联动*/

          var updateReference=function(specSelected,specvidarr){

                var fix=(specvidarr.length==specItems.length);
                setbuyBtnTip();
                var productIntersection=[];

                /*当前已选择规格的商品交集*/
                 var specTip=[];
                 var picsId=[];
                if(specSelected){
                    specSelected.each(function(s){
                         productIntersection.combine(SPEC_HASH[s.get('specvid')]['product_id']);

                         specTip.include("<font color=\"#ED145B\">"+getSpecText(s)+"</font>");
                         picsId.combine(SPEC_HASH[s.get('specvid')]['images']);
                    });
                }

                if(!productIntersection||!productIntersection.length)return referencePointDef();


                var price=[];
                productIntersection.each(function(pid){
                    var product=PRODUCT_HASH[pid];
                    /*if(storeCount.toInt()>9999){
                      storeCount='9999+';
                    }else{
                      storeCount=storeCount.toInt()+product['store'].toInt();
                    }*/

                    price.include(product['price']).clean();

                });

                /*相册联动*/
                picsId = picsId.clean();
                if(picsId.length){
                    updatepic(picsId.join(','));
                }
                /*库存联动
                referencePoint.update('store',storeCount.toInt()>9999?'9999+':storeCount);*/

                /*价格联动*/
                if(price.length>1){
                      price.sort(function(p1,p2){
                         p1=p1.toInt();
                         p2=p2.toInt();
                         if(p1>p2)return 1;
                         if(p1==p2)return 0;
                         return -1;
                      }); 
  if(price[0])
                      referencePoint.update('price',priceControl.format(price[0])+'-'+priceControl.format(price[price.length-1]));
                }else{
                     referencePoint.update('price',priceControl.format(price[0]));
                }

                /*规格选择提示联动*/
                referencePoint.update('specTip','<em><{t}>您已选择：<{/t}></em><span>'+specTip.join("-")+'</span>');
                var product_hiddenInput=$E('#goods-spec input[name^=goods[product_id]').set('disabled',!fix);
                var mprice=$E('#goods-viewer .mprice');


               /*定位到货品*/
                if(fix){
                     var fixProductID=null;
                     PRODUCT_HASH.each(function(v,k){
                          if($A(v['spec_private_value_id']).combine(specvidarr).length==specvidarr.length){
                             fixProductID=k;
                          }
                     });
            
                     if(fixProductID){
                 var fixProduct=PRODUCT_HASH[fixProductID];
                     referencePoint.update('weight',fixProduct['weight']);
                     referencePoint.update('bn',fixProduct['bn']);
                     referencePoint.update('store',fixProduct['store']||0);
 !fixProduct['price']?referencePoint.update('price',priceControl.format('0')):
                     referencePoint.update('price',priceControl.format(fixProduct['price']));
                     product_hiddenInput.set('value',fixProductID);

                    

                      /*优惠联动*/

                      if(referencePoint['discount']&&referencePoint['marketPrice']){
                          var dcType={
                                     T1:'节省',
                                     T2:'优惠',
                                     T3:'折'
                                    };
                          var _discount=referencePoint['discount'];
                          var _discountValue=_discount.get('text');
                          var fdt=priceControl._format.sign;

                          var _priceValue = fixProduct['price'];

                          var _priceMarketValue = fixProduct['mktprice'];

                          var _priceDiff=_priceMarketValue-_priceValue;
 
                          if(_priceDiff>0){
                              if(_discountValue.test(dcType.T2,'i')){
                                referencePoint.update('discount','优惠：'+(_priceDiff/_priceMarketValue*100).toFixed(1)+'%');
                              }else if(_discountValue.test(dcType.T3,'i')){
                                referencePoint.update('discount',((1 - _priceDiff/_priceMarketValue)*10).toFixed(1)+'折');
                              }else{
                                referencePoint.update('discount','节省：'+priceControl.format(_priceDiff));
                              }
                          }
                          else{
                                referencePoint.update('discount','');
                          }
                      }

                     /*库存联动*/
                     if(referencePoint['store']&&(referencePoint['store'].getText().toInt()<1)){

                           buyBtn.hide();
                           notifyBtn.setStyle('display','inline');
                           notifyBtn.getPrevious('.btn-fastbuy')?notifyBtn.getPrevious('.btn-fastbuy').setStyle('visibility','hidden'):$empty();
                           return;
                      }

                     if(buynum=$E('#goods-viewer .buyinfo input[type=text]')){
                        buynum.fireEvent('keyup');
                     }

                      /*会员价联动*/
                      if(mprice){
                          mprice.getElements('.mlvprice').each(function(lvp){
                              lvp.set('text',priceControl.format(fixProduct['mprice'][lvp.get('mlv')]));
                          });
                          mprice.show();
                      }


                      
                   }

                }else{
                   if(mprice)
                   mprice.hide();
                }

                   buyBtn.show();
                   notifyBtn.hide();



          };


		  var _store=$('goods-viewer').getElement('.store').getText();
          var specSelections=$$('#goods-spec .spec-item a[specvid]');
              specSelections.addEvent('click',function(e){
                     e?e.stop():e;
                     this.blur();
                     var specid=this.get('specid');
                     var specvid=this.get('specvid');
                     var prt=this.getParent('li.content')||this.getParent('ul');

                     if(this.hasClass('lock'))return; 
                     if(this.hasClass('selected')){                     
                           this.removeClass('selected');
                           if(prt.hasClass('content')){
                                 var handle=prt.retrieve('handle');
                                 $E('span',handle).set('text','请选择').removeClass('select');
                                 handle.removeClass('curr');
                                 prt.removeClass('content-curr');
                           }
                           var n=$$('#goods-spec .specItem a.selected').length;
                           if(n<1){
                               specSelections.each(function(s){s.removeClass('lock');});
							   $('goods-viewer').getElement('.store').set('text',_store);
                           }else{   
                               var spec=$$('#goods-spec .specItem a.selected')[0];
                               specvid=spec.get('specvid');
                               specid=spec.get('specid');
                               specSelectedCall(specvid,specid,this);
                           }
                            return;
                     }
                     if(this.getParent('ul').getElement('a.selected')){
                         specSelections.each(function(s){   
                             s.removeClass('lock');
                         });
                     }
                     var tempsel=prt.retrieve('ts',this);
                     if(tempsel!=this){tempsel.removeClass('selected')}
                     prt.store('ts',this.addClass('selected'));

                          if(prt.hasClass('content')){
                                 var handle=prt.retrieve('handle');
                                 $E('span',handle).set('text',getSpecText(this)).addClass('select');
                                 handle.removeClass('curr');
                                 prt.removeClass('content-curr');
                           }


                      specSelectedCall(specvid,specid,this);

                      if(e&&e.fireFromProductsList)return;
                      popAloneSpec();
              });



        void function(){
           /*下拉方式的规格选择*/
          var specHandles=$$('#goods-spec .spec-item .handle');
          var specContents=$$('#goods-spec .spec-item .content');

          var tempSlipIndex=0;
          var tempCurrentIndex=-1;

              specHandles.each(function(handle,index){
                 var content=specContents[index];
                 var contentPadding=content.getPadding();
                     content.store('handle',handle);
                     handle.addEvent('click',function(e){
                          if(tempCurrentIndex>=0&&tempCurrentIndex!=index){
                              specHandles[tempCurrentIndex].removeClass('curr');
                              specContents[tempCurrentIndex].removeClass('content-curr');
                           }
                           tempCurrentIndex=index;
                           this.toggleClass('curr');
                           content.toggleClass('content-curr');
                           content.setStyles({'top':this.getCis().bottom-4,
                                              'left':specHandles[0].getPosition().x-3,
                                              'width':this.getParent('.goods-spec').getSize().x-(contentPadding.x+contentPadding.y+14)
                           });
                     });
                 });
             }();
          /*规格点击时call此函数*/
         
          var specSelectedCall=function(specvid,specid,spec){
               var selectedHS=new Hash();   
               var specSelected=$$('#goods-spec .spec-item a.selected');
               var specItems=$$('#goods-spec .specItem');
                
               specItems.each(function(item){
                   if(el=item.getElement('a.selected')){
                      var key=specExtend.suffix(el.get('specvid')); 
                      selectedHS.set(key,el.get('specvid'));
                   }   
               });
                    
               selectedHS=specExtend.sort(selectedHS);  

               var em=(spec.getParent('li.content')&&spec.getParent('li.content').retrieve('handle')
                       ||spec.getParent('.spec-item')).getElement('em');
                em[spec.hasClass('selected')?'addClass':'removeClass']('check');    
                var specs=specExtend.init(selectedHS,specvid);              
        
               specSelections.each(function(s){             
                    specs.indexOf(s.get('specvid'))>-1?s.removeClass('lock'):s.addClass('lock');
                });             
                
                updateReference(specSelected,selectedHS.getValues());
            };  
    
        var specExtend={
            sort:function(selectedHS){
                var sortItem=selectedHS.getKeys().sort();
                    var hs=new Hash();
                    sortItem.each(function(arr){
                        hs.set(arr,selectedHS.get(arr));
                }); 
                return hs;
            },
            suffix:function(specvid){
                var specsub;
                PRODUCT_SPECV_ARR.each(function(item){
                    item.each(function(s,i){
                        if(s==specvid){specsub=i;return;}
                    });
                });
                return specsub;
            },
            to_match:function(regExp){
                var to_string=[];
                PRODUCT_SPECV_ARR.each(function(item){
                    to_string.include(":"+item.join(':')+":");
                }); 
                var specSeleted=[]; 
                to_string.each(function(arr,key){
                    if(regExp.test(arr)){specSeleted.include(arr);}         
                }); 
                return specSeleted; 
            },
            to_arr:function(str){
                var spec_arr=[];    
                str.each(function(item){
                    var tmparr=item.split(":"); 
                    tmparr.pop();tmparr.shift();    
                    spec_arr.include(tmparr);                       
                });
                return spec_arr;
            },
            merge:function(arr){
                var spec_arr=[];            
                arr[0].each(function(e,i){
                    var sarr=[];
                    arr.each(function(el){
                        sarr.include(el[i]);
                    });
                    spec_arr.push(sarr);
                });             
                return spec_arr;
            },
            collect:function(prearr,arr,hs,key,state){
                var inarr=[];
                var hskeys=hs.getKeys();
                prearr.each(function(el,index){
                    var barr=[],jarr=[];
                    if(key!=index&&hskeys.contains(index.toString())&&hskeys.length!=prearr.length&&!state){                
                        barr.combine(prearr[index]);
                        barr.combine(arr[index]);
                        inarr.include(barr);
                    }else{              
                        arr[index].each(function(item){
                            if(el.contains(item)){
                                jarr.include(item);
                            }
                        }); 
                        inarr.include(jarr);
                    }
                });
                inarr[key]=prearr[key];
                return inarr;
            },
            findCall:function(regexp){
                var inSelected=specExtend.to_match(regexp);             
                var tmparr=specExtend.to_arr(inSelected);               
                return specExtend.merge(tmparr);
            },
            to_find:function(selectedHS,specvid){
                var subReg=":"+selectedHS.getValues().join(":(\\d+:)*")+":";    
                var tpReg = new RegExp(""+subReg.split("(:\\d+:)*")+"");
                var keys=selectedHS.keyOf(specvid);         
                var filterArr=[];                       
                var chs=$H(selectedHS);
            
                if(selectedHS.getKeys().length>2){
                    chs.erase(keys);
                    chs.each(function(item,key){
                        var tmphs=$H(chs);
                        tmphs.each(function(value,i){
                            if(key==i){ 
                                tmphs.erase(i);
                                tmphs.set(keys,specvid);
                            }
                        });
                        var hs=specExtend.sort(tmphs);
                        filterArr.push(hs.getValues());
                    });                 
                    var sbReg="";                   
                    filterArr.each(function(item,key){
                        var reg=item.join(":(\\d+:)*");
                        sbReg+=":"+reg+":|";            
                    });
                    sbReg=new RegExp(""+sbReg.substr(0,sbReg.length-1)+"");     
                    if(chs){                        
                        var loop=arguments.callee;
                        var preStore=loop(chs,chs.getValues()[0]);                      
                    }                   
                    var sbSpec=specExtend.findCall(sbReg);
                    var sbCollect=specExtend.collect(preStore,sbSpec,selectedHS,keys,true);
                }else{              
                    filterArr=selectedHS.getValues();
                    var sbReg=new RegExp(""+filterArr.join("|")+"");
                    var sbCollect=specExtend.findCall(sbReg);                   
                }                   
                var tpCollect=specExtend.findCall(tpReg);   
                var specs=specExtend.collect(sbCollect,tpCollect,selectedHS,keys);
                if(selectedHS.getKeys().length==PRODUCT_SPECV_ARR[0].length)specs=sbCollect;                
                return specs;
            },
            init:function(selectedHS,specvid){          
                if(selectedHS.getKeys().length>1){              
                    var specItems=specExtend.to_find(selectedHS,specvid);           
                    var specArr=specItems.flatten();    
                }else{
                    var regExp = new RegExp(":"+specvid+":");
                    var specSelected=specExtend.to_match(regExp);
                    var specItems=specExtend.to_arr(specSelected);                 
                    var specArr=[];         
                    specItems.each(function(item){specArr.combine(item);}); 
                    var items;
                    $$('#goods-spec .specItem').map(function(item,index){
                        if(item.getElements('a').get('specvid').contains(specvid))items=item;
                    });
                    items=items.getElements('a').get('specvid');
                    specArr.combine(items);         
                }
                return specArr; 
            }
        };  
		/*
          var fixProductHidden = $E('#goods-spec input[name^=goods[product_id]');
          var gpList=$('goods-products-list').addEvents({
                 pop:function(){
                  this.setStyles({
                      width:$('goods-viewer').getSize().x,
                      top:$('goods-viewer').getPosition().y,
                      left:$('goods-viewer').getPosition().x,
                      display:'block'
                  });
                  if(this.getSize().y>300){

                     this.setStyles({
                        height:300,
                        'overflow-y':'auto'
                     });
                  }
                  this.getElements('tbody tr').each(function(tr){
                       var fixProductId = fixProductHidden.disabled?false:fixProductHidden.value;
                       if(tr.get('productid') == fixProductId){
                           tr.addClass('selected');
                       }else{
                           tr.removeClass('selected');
                       }
                  });

                  $(document.body).addEvent('click',function(e){
                         this.fireEvent('unvisible');
                         $(document.body).removeEvent('click',arguments.callee);

                  }.bind(this));

                },
                unvisible:function(){
                     this.setStyles({
                      top:-20000,
                      display:'none'
                    });
                }
          });

          gpList.getElements('tbody tr').addEvents({
              mouseenter:function(){
                  this.addClass('mouseover');
              },
              mouseleave:function(){
                  this.removeClass('mouseover');
                  this.fireEvent('mouseup');
              },
              mousedown:function(){
                  this.addClass('mousedown');
              },
              mouseup:function(){
                  this.removeClass('mousedown');
              },
              click:function(){
                   this.fireEvent('ischecked');

              },
              ischecked:function(){
                  var productId = this.get('productId');
                  var productMap = PRODUCT_HASH[productId];
                  var specIDarr = productMap['spec_private_value_id'];
                  $$('#goods-spec .spec-item a.selected').fireEvent('click');
                  specIDarr.each(function(s){
                         var specEl=$E('#goods-spec .spec-item a[specvid='+s+']');
                         if(!specEl)return;
                         specEl.fireEvent('click',{stop:$empty,fireFromProductsList:true});
                  });

              }
          });*/
      }();
 </script>
 <{elseif $goods.store==='0'}>
     <script>
     /*无规格商品到货通知 show*/
      window.addEvent('domready',function(){

            var notifyBtn=$E('#goods-viewer .btn-notify').store('tip:text','您当前要购买的商品暂时缺货,点击进入缺货登记页.');
            new Tips(notifyBtn,{className:'cantbuy',showDelay:0,hideDelay:0});
            notifyBtn.show();
            notifyBtn.addEvent('click',function(e){
                      e.stop();
                      this.blur();
                      this.form.action=this.form.get('gnotify');
                      this.form.submit();
                });
      });
     </script>
 <{else}>
     <script>
     window.addEvent('domready',function(){
                        /*快速购买*/
              var fastbuyBtn = $E('#goods-viewer .btn-fastbuy');
              if(fastbuyBtn){
                      fastbuyBtn.addEvent('click',function(e){

                           e.stop();
                           this.blur();
                            var form = $('fastbuy-form');
                           form.empty().adopt($(this.form).toQueryString().toFormElements());
                           form.adopt(new Element('input', {name:'isfastbuy',value:1,type:'hidden'}));
                           /*check min/maxorder by showker2011-1-22begin*/
							  if('<{$goods.minorder|trim}>'){
							   var sknum=$E('#goods-viewer .buyinfo input[name^=goods[num]').value;
							   var skminorder='<{$goods.minorder|trim}>';
							  if(sknum>parseInt(skminorder)){                  
                            	alert("该商品限制购买数量为"+skminorder+",您的购买数量超出了");return false;
                           }
                           }
                           /*check min/maxorder by showker2011-1-22begin*/
                           if(!form.retrieve('events',{})['submit'])return form.submit();
                           form.fireEvent('submit',e);
                       });
                  }

      });
     </script>
 <{/if}>
<{/if}>



 <{if $goods.adjunct && count($goods.adjunct)>0}>
  <script>
     /*配件JS*/
    void function(){

     var updateAdjunctPrice=function(){
           var adjunctPrice=0;

           var selected=$$('#goods-adjunct tr').filter(function(tr,index){

                       return tr.getElement('input[type=checkbox]').checked;

           });
           selected.each(function(s,i){
               adjunctPrice+=s.get('price').toFloat()*s.getElement('input[type=hidden]').value.toFloat();
           });
           var price=isNaN(adjunctPrice)?0:adjunctPrice;
           $E('#goods-adjunct .price').set('text',priceControl.format(price));


      };



        var adjunctCheckbox=$ES('#goods-adjunct input[type=checkbox]');
        var adjunctText=$ES('#goods-adjunct input[type=text]');


        adjunctCheckbox.addEvent('click',function(e){
              var  prt=this.getParent('tr');
              var  min_num=prt.getParent('tbody').get('min_num').toInt();
              if(isNaN(min_num)||min_num<1)min_num=1;

              var _hidden=prt.getElement('input[type=hidden]').set('disabled',!this.checked);

              this.checked?prt.setStyle('background','#e9e9e9'):prt.setStyle('background','#fff');

              var _text=prt.getElement('input[type=text]');

              if(!_text.value||_text.value<min_num){

                _hidden.value=_text.value=min_num;
              }else{
                _hidden.value=_text.value;
              }
              updateAdjunctPrice();

        });

        adjunctText.addEvent('keydown',function(e){
          if($A(keyCodeFix).include(e.code).length>25)
           e.stop();
        });
        adjunctText.addEvent('keyup',function(e){
              var  prt=this.getParent('tr');
              var min_num=prt.getParent('tbody').get('min_num').toInt();
              var max_num=prt.getParent('tbody').get('max_num').toInt();
              var _hidden=prt.getElement('input[type=hidden]');
              if(isNaN(min_num)||min_num<0){
                 min_num=0;
              };
              if(isNaN(max_num)||max_num<0){
                 max_num=Number.MAX_VALUE;
              };
              if(this.value){
                _hidden.value=this.value=this.value.toInt().limit(min_num,max_num);
              }
              updateAdjunctPrice();
        });



    }();

  </script>

<{/if}>

<script>
/*设置浏览过的商品*/
withBroswerStore(function(broswerStore){
  broswerStore.get('history',function(history){
  history=JSON.decode(history);
  if(!history||$type(history)!=='array')history=[];
   if(history.length==40){history.pop()};
   var newhis={'goodsId':<{$goods.goods_id}>,
               'goodsName':'<{$goods.name|replace:"'":"\'"}>',
               'goodsImg':'<{$images.gimages[$goods.image_default].small|storager}>',
               'viewTime':$time()
              };
   if(!history.some(function(i,index){


   if(i['goodsId']==newhis['goodsId']){
         history.erase(i);
         history.include(newhis)
         return true;
   }
      return false;

   })){
       history.include(newhis);
   }
   broswerStore.set('history',history);

  });
});


window.addEvent('domready', function(){
/*Tab的处理*/
try{
var viewTabsContainer=$E('#goods-viewer .goods-detail-tab');
var viewTabs=[];
var viewSections=$$('#goods-viewer .section');

viewSections.each(function(se){
  var t=new Element('div',{'class':'goodsDetailTab'}).set('html','<span>'+se.get('tab')+'</span>');
  viewTabs.push(t);

});

viewTabsContainer.adopt(viewTabs);

new ItemAgg(viewTabs,viewSections,{activeName:'active',
	onActive:function(tab,item){
			  var anotherItems=$$($A(this.items).remove(item));
	
			 if(tab.getElement('span').get('text')=='商品详情'){
			 /*anotherItems.show(); --by czy 20110301---*/ 
			 anotherItems.each(function(e){
				 if(e.get('rel') != 'noshow'){
				 e.show();
				}
			 });
			 }else{
			  anotherItems.hide();
	}
	}});
}catch(e){}

});

/*验证码刷新*/
function changeimg(id,type){
    $(id).set('src','<{link ctl="passport" act="verifyCode" arg0="'+type+'"}>#'+$time());
};

</script>

<script>
var countdown_task = new Class({
    begin: 0,
	end: 0,
	tasktimeBox: null,
    initialize: function(id, begin, end, store, widgets){
	    this.begin = begin;
		this.end = end;
		this.tasktimeBox = $(id);
		//this.item = $('pdt_'+id);
		this.id = id;
	//	this.li = this.item.getElement('li.gp');
		if(store<1){
			this.set_box(5);
			return this.tasktimeBox.set('html','<span class="off">抢购结束</span>');
		}
		if(begin>0){
			this.set_box(1);
		}
		this.auto_trackTime();
	},
	auto_trackTime: function(){
		var str,sec,day,hour,minute,hour,second,cd=3;
		if(this.begin >= 0){
			sec = this.begin--;
			if(this.begin<0){
			    this.set_box(2);
			    sec = this.end--;
			    this.li.set('html','<span class="price0"><{$setting.priceText|default:"抢购价"}></span><span class="price1">'+this.li.get('price')+'</span>');
				try{$('btn_'+this.id).removeClass('addcart1');}catch(e){}
			}
		}else{
			sec = this.end--;
		}
		if(this.end<0) {
			this.set_box(5);
			return this.tasktimeBox.set('html','<span class="off">抢购结束</span>');
		}
		if(this.begin<0){
			if(this.end<3600) cd=4;
			else if(this.begin>-3600) cd=2;
			this.set_box(cd);
		}
		str=''+(this.begin>=0 ? '' : '');
		day=(sec/(3600*24)).toInt();sec-=day*3600*24;
		hour=(sec/3600).toInt();sec-=hour*3600;
		minute=(sec/60).toInt();
		second=sec%60;
		str +=''+day+'<em>天</em>';
 		str +=''+hour+'<em>时</em>';
 		str +=''+minute+'<em>分</em>';
		str+=''+second+'<em>秒</em>';
		str+= this.begin>=0 ? '后开始' : '';
		this.tasktimeBox.set('html',str);
		var _this = this;
		(function(){_this.auto_trackTime()}).delay(1000);
	},
	set_box: function(i){
	}
});
new countdown_task('timer',<{$tuan.begin_time-$ntime}>,<{$tuan.expire_time-$ntime}>,'999999');
</script>